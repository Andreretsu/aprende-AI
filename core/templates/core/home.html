<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprende AI - AlfabetizaÃ§Ã£o com IA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        .progresso {
            text-align: center;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        
        .palavra-display {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .palavra {
            font-size: 3em;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .btn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .feedback {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: bold;
            display: none;
        }
        
        .feedback.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        
        .feedback.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .recording {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .transcricao {
            margin-top: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            text-align: center;
            font-style: italic;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ¤– Aprende AI</h1>
        <p class="subtitle">AlfabetizaÃ§Ã£o com InteligÃªncia Artificial</p>
        
        <div class="progresso" id="progresso">Carregando...</div>
        
        <div class="palavra-display">
            <div class="palavra" id="palavra">Carregando...</div>
            <button class="btn btn-success" onclick="ouvirPalavra()">ðŸ”Š Ouvir Palavra</button>
        </div>
        
        <button class="btn" id="btnGravar" onclick="toggleGravacao()">ðŸŽ¤ ComeÃ§ar a Gravar</button>
        <button class="btn" onclick="novaPalavra()">ðŸ”„ PrÃ³xima Palavra</button>
        
        <div class="status" id="status"></div>
        <div class="feedback" id="feedback"></div>
        <div class="transcricao" id="transcricao" style="display:none;"></div>
    </div>

    <!-- Biblioteca RecordRTC para gravar Ã¡udio -->
    <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
    
    <script>
        let palavraAtual = '';
        let recorder;
        let isRecording = false;
        let recordingTimeout;

        // Carrega primeira palavra ao iniciar
        window.onload = function() {
            novaPalavra();
        };

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function novaPalavra() {
            try {
                updateStatus('Carregando nova palavra...');
                const response = await fetch('/api/nova-palavra/');
                const data = await response.json();
                palavraAtual = data.palavra;
                document.getElementById('palavra').textContent = palavraAtual;
                document.getElementById('progresso').textContent = `Progresso: ${data.progresso}`;
                document.getElementById('feedback').style.display = 'none';
                document.getElementById('transcricao').style.display = 'none';
                updateStatus('Pronto! Clique em "Ouvir Palavra" para escutar.');
            } catch (error) {
                console.error('Erro ao buscar palavra:', error);
                updateStatus('Erro ao carregar palavra.');
            }
        }

        async function ouvirPalavra() {
            try {
                updateStatus('Gerando Ã¡udio...');
                const response = await fetch('/api/tts/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ texto: palavraAtual })
                });
                
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
                updateStatus('Reproduzindo Ã¡udio...');
                
                audio.onended = () => {
                    updateStatus('Agora Ã© sua vez! Clique em "ComeÃ§ar a Gravar".');
                };
            } catch (error) {
                console.error('Erro ao ouvir palavra:', error);
                updateStatus('Erro ao reproduzir Ã¡udio.');
            }
        }

        async function toggleGravacao() {
            if (!isRecording) {
                await iniciarGravacao();
            } else {
                pararGravacao();
            }
        }

        async function iniciarGravacao() {
            const btnGravar = document.getElementById('btnGravar');
            
            try {
                updateStatus('Solicitando permissÃ£o do microfone...');
                
                // Solicita acesso ao microfone
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    }
                });
                
                // Configura o RecordRTC
                recorder = RecordRTC(stream, {
                    type: 'audio',
                    mimeType: 'audio/wav',
                    recorderType: RecordRTC.StereoAudioRecorder,
                    numberOfAudioChannels: 1,
                    desiredSampRate: 16000
                });
                
                recorder.startRecording();
                isRecording = true;
                
                btnGravar.classList.add('recording', 'btn-danger');
                btnGravar.classList.remove('btn');
                btnGravar.textContent = 'â¹ï¸ Parar GravaÃ§Ã£o (ou aguarde 3s)';
                
                updateStatus('ðŸ”´ GRAVANDO... Fale a palavra AGORA!');
                
                // PARA AUTOMATICAMENTE APÃ“S 3 SEGUNDOS
                recordingTimeout = setTimeout(() => {
                    if (isRecording) {
                        updateStatus('Tempo esgotado! Processando...');
                        pararGravacao();
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Erro ao acessar microfone:', error);
                updateStatus('âŒ Erro ao acessar microfone. Verifique as permissÃµes.');
                alert('Erro ao acessar microfone. Verifique se vocÃª deu permissÃ£o ao navegador.');
            }
        }

        function pararGravacao() {
            const btnGravar = document.getElementById('btnGravar');
            
            if (!recorder) return;
            
            // Limpa o timeout se existir
            if (recordingTimeout) {
                clearTimeout(recordingTimeout);
            }
            
            updateStatus('Finalizando gravaÃ§Ã£o...');
            btnGravar.disabled = true;
            
            // Usa Promise para garantir que o stop funcione
            recorder.stopRecording(async function() {
                try {
                    let blob = recorder.getBlob();
                    
                    // Para o stream
                    if (recorder.stream) {
                        recorder.stream.getTracks().forEach(track => track.stop());
                    }
                    
                    isRecording = false;
                    btnGravar.classList.remove('recording', 'btn-danger');
                    btnGravar.classList.add('btn');
                    btnGravar.textContent = 'ðŸŽ¤ ComeÃ§ar a Gravar';
                    
                    updateStatus('Processando Ã¡udio...');
                    
                    // Aguarda um pouco antes de enviar
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    enviarAudio(blob);
                } catch (error) {
                    console.error('Erro ao finalizar gravaÃ§Ã£o:', error);
                    updateStatus('Erro ao processar gravaÃ§Ã£o.');
                    btnGravar.disabled = false;
                }
            });
        }

        async function enviarAudio(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'gravacao.wav');
            formData.append('palavra_esperada', palavraAtual);

            try {
                updateStatus('Enviando para IA analisar...');
                
                const response = await fetch('/api/stt/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                const feedbackEl = document.getElementById('feedback');
                const transcricaoEl = document.getElementById('transcricao');
                const btnGravar = document.getElementById('btnGravar');
                
                btnGravar.disabled = false;
                
                if (data.error) {
                    feedbackEl.className = 'feedback error';
                    feedbackEl.textContent = 'âŒ ' + data.error;
                    updateStatus('Erro ao processar.');
                    return;
                }
                
                if (data.transcricao) {
                    transcricaoEl.textContent = `VocÃª disse: "${data.transcricao}"`;
                    transcricaoEl.style.display = 'block';
                } else {
                    transcricaoEl.textContent = 'Nenhuma fala detectada';
                    transcricaoEl.style.display = 'block';
                }
                
                if (data.acertou) {
                    feedbackEl.className = 'feedback success';
                    feedbackEl.textContent = 'ðŸŽ‰ ' + data.mensagem;
                    updateStatus('ParabÃ©ns! Carregando prÃ³xima palavra...');
                    setTimeout(() => novaPalavra(), 3000);
                } else {
                    feedbackEl.className = 'feedback error';
                    feedbackEl.textContent = data.mensagem;
                    updateStatus('Tente novamente!');
                }
            } catch (error) {
                console.error('Erro ao enviar Ã¡udio:', error);
                const feedbackEl = document.getElementById('feedback');
                feedbackEl.className = 'feedback error';
                feedbackEl.textContent = 'Erro ao processar Ã¡udio. Tente novamente.';
                updateStatus('Erro de conexÃ£o.');
                document.getElementById('btnGravar').disabled = false;
            }
        }
    </script>
</body>
</html>
